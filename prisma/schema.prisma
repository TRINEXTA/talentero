// ============================================
// TALENTERO - Schéma Base de Données
// Plateforme de recrutement freelance IT
// Opérée par TRINEXTA
// ============================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// AUTHENTIFICATION & UTILISATEURS
// ============================================

model User {
  id            Int       @id @default(autoincrement())
  uid           String    @unique @default(uuid())
  email         String    @unique
  passwordHash  String?   // Nullable pour les comptes pré-créés par admin
  role          UserRole  @default(TALENT)
  emailVerified Boolean   @default(false)
  isActive      Boolean   @default(true)

  // Token pour finalisation de compte (import CV admin)
  activationToken       String?   @unique
  activationTokenExpiry DateTime?

  // Reset password
  resetToken            String?   @unique
  resetTokenExpiry      DateTime?

  // Relations selon le rôle
  talent        Talent?
  client        Client?

  // Sessions & Tokens
  sessions      Session[]

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  lastLoginAt   DateTime?

  // Créé par admin (import manuel)
  createdByAdmin Boolean  @default(false)
}

enum UserRole {
  TALENT    // Freelance
  CLIENT    // Entreprise
  ADMIN     // TRINEXTA
}

model Session {
  id        Int      @id @default(autoincrement())
  token     String   @unique
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    Int
  expiresAt DateTime
  userAgent String?
  ipAddress String?

  createdAt DateTime @default(now())
}

// ============================================
// TALENTS (FREELANCES)
// ============================================

model Talent {
  id                    Int       @id @default(autoincrement())
  uid                   String    @unique @default(uuid())
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId                Int       @unique

  // Statut du compte
  compteLimite          Boolean   @default(false)  // Sans SIRET (en cours de création)
  compteComplet         Boolean   @default(false)  // Profil entièrement rempli
  importeParAdmin       Boolean   @default(false)  // CV importé manuellement

  // Identité
  prenom                String
  nom                   String
  telephone             String?
  photoUrl              String?
  nationalite           String?   // Pour les projets secret défense

  // Entreprise / SIRET (optionnel si compteLimite)
  siret                 String?   @unique
  siren                 String?
  raisonSociale         String?
  dateCreationEntreprise DateTime?
  codeAPE               String?
  libelleAPE            String?
  formeJuridique        String?
  typeSociete           TypeSociete?
  siretVerifie          Boolean   @default(false)
  siretVerifieLe        DateTime?
  siretEnCoursCreation  Boolean   @default(false)  // En attente de SIRET

  // TVA
  tvaIntracommunautaire String?
  assujettTva           Boolean   @default(false)

  // Adresse
  adresse               String?
  codePostal            String?
  ville                 String?
  pays                  String    @default("France")

  // Zone d'intervention et mobilité
  zonesIntervention     String[]
  permisConduire        Boolean   @default(false)
  vehicule              Boolean   @default(false)
  accepteDeplacementEtranger Boolean @default(false)

  // Profil Professionnel
  titrePoste            String?
  bio                   String?
  competences           String[]
  anneesExperience      Int       @default(0)

  // Conditions de travail
  tjm                   Int?
  tjmMin                Int?
  tjmMax                Int?
  mobilite              Mobilite  @default(FLEXIBLE)
  zonesGeographiques    String[]
  disponibilite         Disponibilite @default(IMMEDIATE)
  disponibleLe          DateTime?

  // Documents
  cvUrl                 String?
  cvOriginalName        String?
  cvParsedData          Json?

  // Compétences détaillées (extraites du CV)
  logiciels             String[]
  frameworks            String[]
  baseDonnees           String[]
  methodologies         String[]
  outils                String[]

  // Extras
  softSkills            String[]
  langues               String[]
  loisirs               String[]
  certifications        String[]
  linkedinUrl           String?
  githubUrl             String?
  portfolioUrl          String?

  // Visibilité
  statut                TalentStatus @default(ACTIF)
  visiblePublic         Boolean   @default(true)
  visibleVitrine        Boolean   @default(false)  // Affiché sur la page vitrine

  // Relations
  experiences           Experience[]
  formations            Formation[]
  candidatures          Candidature[]
  matchs                Match[]
  alertes               Alerte[]
  messagesEnvoyes       Message[] @relation("MessagesSent")
  messagesRecus         Message[] @relation("MessagesReceived")

  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@index([competences])
  @@index([ville])
  @@index([disponibilite])
  @@index([statut])
}

enum TypeSociete {
  AUTO_ENTREPRENEUR
  EURL
  SASU
  SARL
  SAS
  PORTAGE
  AUTRE
}

enum Mobilite {
  FULL_REMOTE
  HYBRIDE
  SUR_SITE
  FLEXIBLE
}

enum Disponibilite {
  IMMEDIATE
  SOUS_15_JOURS
  SOUS_1_MOIS
  SOUS_2_MOIS
  SOUS_3_MOIS
  DATE_PRECISE
  NON_DISPONIBLE
}

enum TalentStatus {
  ACTIF
  INACTIF
  EN_MISSION
  SUSPENDU
}

model Experience {
  id           Int        @id @default(autoincrement())
  talent       Talent     @relation(fields: [talentId], references: [id], onDelete: Cascade)
  talentId     Int

  poste        String
  entreprise   String?
  lieu         String?
  dateDebut    DateTime
  dateFin      DateTime?
  enCours      Boolean    @default(false)
  description  String?
  competences  String[]

  createdAt    DateTime   @default(now())
}

model Formation {
  id           Int        @id @default(autoincrement())
  talent       Talent     @relation(fields: [talentId], references: [id], onDelete: Cascade)
  talentId     Int

  diplome      String
  etablissement String?
  annee        Int?
  description  String?

  createdAt    DateTime   @default(now())
}

// ============================================
// CLIENTS (ENTREPRISES)
// ============================================

model Client {
  id                    Int       @id @default(autoincrement())
  uid                   String    @unique @default(uuid())
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId                Int       @unique

  // Type de client
  typeClient            TypeClient @default(DIRECT)

  // Entreprise
  raisonSociale         String
  siret                 String?   @unique
  siren                 String?
  codeAPE               String?
  formeJuridique        String?

  // Adresse principale
  adresse               String?
  codePostal            String?
  ville                 String?
  pays                  String    @default("France")

  // Infos entreprise
  description           String?
  secteurActivite       String?
  tailleEntreprise      TailleEntreprise?
  siteWeb               String?
  logoUrl               String?
  nombreSites           Int       @default(1)

  // Statut
  statut                ClientStatus @default(EN_ATTENTE)
  valideParAdmin        Boolean   @default(false)
  valideLe              DateTime?

  // Relations
  sites                 ClientSite[]
  contacts              ClientContact[]
  offres                Offre[]
  messagesEnvoyes       Message[] @relation("ClientMessagesSent")
  messagesRecus         Message[] @relation("ClientMessagesReceived")

  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
}

enum TypeClient {
  DIRECT        // Client final qu'on gère directement
  SOUSTRAITANCE // ESN/Client intermédiaire
}

enum TailleEntreprise {
  TPE
  PME
  ETI
  GRANDE
}

enum ClientStatus {
  EN_ATTENTE
  ACTIF
  SUSPENDU
  ARCHIVE
}

// Sites multiples pour un client
model ClientSite {
  id          Int      @id @default(autoincrement())
  client      Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  clientId    Int

  nom         String   // "Siège Paris", "Agence Lyon"
  adresse     String
  codePostal  String
  ville       String
  pays        String   @default("France")
  telephone   String?

  estSiegeSocial Boolean @default(false)

  createdAt   DateTime @default(now())
}

// Contacts multiples pour un client
model ClientContact {
  id          Int      @id @default(autoincrement())
  client      Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  clientId    Int

  prenom      String
  nom         String
  email       String
  telephone   String?
  poste       String?  // "DRH", "CTO", "Responsable Recrutement"

  estContactPrincipal Boolean @default(false)
  recevoirNotifications Boolean @default(true)

  createdAt   DateTime @default(now())
}

// ============================================
// OFFRES D'EMPLOI
// ============================================

model Offre {
  id                    Int       @id @default(autoincrement())
  uid                   String    @unique @default(uuid())
  slug                  String    @unique

  // Créateur
  client                Client?   @relation(fields: [clientId], references: [id], onDelete: SetNull)
  clientId              Int?
  createdByAdmin        Boolean   @default(false)

  // Type d'offre
  typeOffre             TypeOffre @default(INTERNE)

  // Contenu
  titre                 String
  description           String
  responsabilites       String?
  profilRecherche       String?

  // Compétences
  competencesRequises   String[]
  competencesSouhaitees String[]

  // Conditions - TJM
  tjmClient             Int?      // TJM réel du client (jamais affiché)
  tjmAffiche            Int?      // TJM affiché (notre marge incluse)
  tjmMin                Int?      // Fourchette basse affichée
  tjmMax                Int?      // Fourchette haute affichée
  tjmADefinir           Boolean   @default(false)  // "TJM à définir"

  // Mission
  dureeJours            Int?
  dateDebut             DateTime?
  dateFin               DateTime?
  renouvelable          Boolean   @default(false)
  nombrePostes          Int       @default(1)

  // Localisation
  lieu                  String?
  codePostal            String?
  mobilite              Mobilite  @default(FLEXIBLE)
  deplacementEtranger   Boolean   @default(false)

  // Expérience requise
  experienceMin         Int?

  // Habilitations
  habilitationRequise   Boolean   @default(false)
  typeHabilitation      String?   // "Secret Défense", "Confidentiel Défense"

  // Publication
  statut                OffreStatus @default(BROUILLON)
  publieLe              DateTime?
  expireLe              DateTime?
  visiblePublic         Boolean   @default(true)

  // Résultat appel d'offres (pour sous-traitance)
  resultatAO            ResultatAO?
  dateResultat          DateTime?

  // Métriques
  nbVues                Int       @default(0)
  nbCandidatures        Int       @default(0)

  // Relations
  candidatures          Candidature[]
  matchs                Match[]
  shortlist             Shortlist?
  vues                  OffreVue[]

  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@index([competencesRequises])
  @@index([statut])
  @@index([lieu])
  @@index([typeOffre])
}

enum TypeOffre {
  INTERNE       // Client direct qu'on gère
  SOUSTRAITANCE // Appel d'offres pour un donneur d'ordre
}

enum OffreStatus {
  BROUILLON
  EN_ATTENTE    // En attente publication manuelle
  PUBLIEE
  EN_COURS      // Candidatures en cours de traitement
  POURVUE
  FERMEE
  EXPIREE
}

enum ResultatAO {
  EN_ATTENTE
  GAGNEE
  PERDUE
}

// ============================================
// SHORTLIST (Liste de candidats pour une offre)
// ============================================

model Shortlist {
  id          Int       @id @default(autoincrement())
  uid         String    @unique @default(uuid())

  offre       Offre     @relation(fields: [offreId], references: [id], onDelete: Cascade)
  offreId     Int       @unique

  // Statut
  statut      ShortlistStatus @default(EN_COURS)

  // Envoi au client
  envoyeeLe   DateTime?

  // Candidats de la shortlist
  candidats   ShortlistCandidat[]

  notes       String?   // Notes internes TRINEXTA

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

enum ShortlistStatus {
  EN_COURS      // En construction
  PRETE         // Prête à être envoyée
  ENVOYEE       // Envoyée au client
  EN_ATTENTE_RETOUR // Attente retour client
  FINALISEE     // Retour reçu
}

model ShortlistCandidat {
  id            Int       @id @default(autoincrement())

  shortlist     Shortlist @relation(fields: [shortlistId], references: [id], onDelete: Cascade)
  shortlistId   Int

  candidature   Candidature @relation(fields: [candidatureId], references: [id], onDelete: Cascade)
  candidatureId Int

  // Position dans la shortlist
  ordre         Int       @default(0)

  // Retour client
  retenuParClient Boolean?
  commentaireClient String?

  createdAt     DateTime  @default(now())

  @@unique([shortlistId, candidatureId])
}

// ============================================
// MATCHING & CANDIDATURES
// ============================================

model Match {
  id            Int       @id @default(autoincrement())

  offre         Offre     @relation(fields: [offreId], references: [id], onDelete: Cascade)
  offreId       Int
  talent        Talent    @relation(fields: [talentId], references: [id], onDelete: Cascade)
  talentId      Int

  // Score de matching (0-100)
  score         Int
  scoreDetails  Json?

  // Compétences matchées
  competencesMatchees   String[]
  competencesManquantes String[]

  // Notification
  notificationEnvoyee Boolean @default(false)
  notificationEnvoyeeLe DateTime?

  // Statut
  vuParTalent   Boolean   @default(false)
  vuParClient   Boolean   @default(false)

  notes         String?

  createdAt     DateTime  @default(now())

  @@unique([offreId, talentId])
  @@index([score])
}

model Candidature {
  id            Int       @id @default(autoincrement())
  uid           String    @unique @default(uuid())

  offre         Offre     @relation(fields: [offreId], references: [id], onDelete: Cascade)
  offreId       Int
  talent        Talent    @relation(fields: [talentId], references: [id], onDelete: Cascade)
  talentId      Int

  // Candidature
  tjmPropose    Int?
  motivation    String?
  disponibilite Disponibilite?

  // Matching au moment de la candidature
  scoreMatch    Int?

  // Pipeline
  statut        CandidatureStatus @default(NOUVELLE)

  // Dates importantes
  vueLe         DateTime?
  reponduLe     DateTime?
  entretienLe   DateTime?

  // Shortlist
  shortlistCandidats ShortlistCandidat[]

  // Notes
  notesTrinexta String?
  notesClient   String?

  // Notification de refus envoyée
  notificationRefusEnvoyee Boolean @default(false)

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@unique([offreId, talentId])
}

enum CandidatureStatus {
  NOUVELLE
  VUE
  EN_REVUE
  SHORTLIST
  PROPOSEE_CLIENT
  ENTRETIEN
  ACCEPTEE
  REFUSEE
  RETIREE
}

// ============================================
// ALERTES & NOTIFICATIONS
// ============================================

model Alerte {
  id              Int       @id @default(autoincrement())
  talent          Talent    @relation(fields: [talentId], references: [id], onDelete: Cascade)
  talentId        Int

  nom             String?
  competences     String[]
  tjmMin          Int?
  mobilite        Mobilite?
  lieux           String[]

  frequence       AlerteFrequence @default(INSTANTANEE)
  active          Boolean   @default(true)

  derniereNotif   DateTime?
  nbOffresEnvoyees Int      @default(0)

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}

enum AlerteFrequence {
  INSTANTANEE
  QUOTIDIENNE
  HEBDOMADAIRE
}

model Notification {
  id          Int       @id @default(autoincrement())

  userId      Int?
  type        NotificationType

  titre       String
  message     String
  lien        String?

  lu          Boolean   @default(false)
  luLe        DateTime?

  createdAt   DateTime  @default(now())

  @@index([userId, lu])
}

enum NotificationType {
  NOUVELLE_OFFRE
  NOUVELLE_CANDIDATURE
  STATUT_CANDIDATURE
  MESSAGE
  ALERTE_OFFRE
  VALIDATION_COMPTE
  RESULTAT_AO
  SYSTEME
}

// ============================================
// EMAILS
// ============================================

model EmailLog {
  id          Int       @id @default(autoincrement())

  destinataire String
  sujet        String
  template     String    // Nom du template utilisé

  // Contexte
  userId       Int?
  offreId      Int?
  candidatureId Int?

  statut       EmailStatus @default(EN_ATTENTE)
  envoyeLe     DateTime?
  erreur       String?

  createdAt    DateTime  @default(now())
}

enum EmailStatus {
  EN_ATTENTE
  ENVOYE
  ERREUR
}

// ============================================
// MESSAGERIE
// ============================================

model Message {
  id          Int       @id @default(autoincrement())
  uid         String    @unique @default(uuid())

  // Expéditeur/Destinataire (Talent)
  expediteurTalent    Talent? @relation("MessagesSent", fields: [expediteurTalentId], references: [id])
  expediteurTalentId  Int?
  destinataireTalent  Talent? @relation("MessagesReceived", fields: [destinataireTalentId], references: [id])
  destinataireTalentId Int?

  // Expéditeur/Destinataire (Client)
  expediteurClient    Client? @relation("ClientMessagesSent", fields: [expediteurClientId], references: [id])
  expediteurClientId  Int?
  destinataireClient  Client? @relation("ClientMessagesReceived", fields: [destinataireClientId], references: [id])
  destinataireClientId Int?

  // Expéditeur Admin (TRINEXTA)
  expediteurAdmin     Boolean @default(false)

  // Contexte
  offreId     Int?
  sujet       String?
  contenu     String

  // Statut
  lu          Boolean   @default(false)
  luLe        DateTime?

  createdAt   DateTime  @default(now())
}

// ============================================
// LOGS & ANALYTICS
// ============================================

model AuditLog {
  id          Int       @id @default(autoincrement())

  userId      Int?
  action      String
  entite      String
  entiteId    Int?

  details     Json?
  ipAddress   String?
  userAgent   String?

  createdAt   DateTime  @default(now())

  @@index([userId])
  @@index([action])
  @@index([createdAt])
}

model OffreVue {
  id          Int       @id @default(autoincrement())
  offre       Offre     @relation(fields: [offreId], references: [id], onDelete: Cascade)
  offreId     Int

  talentId    Int?
  ipAddress   String?
  userAgent   String?

  createdAt   DateTime  @default(now())

  @@index([offreId])
}

// ============================================
// CONFIGURATION PLATEFORME
// ============================================

model ConfigPlateforme {
  id          Int       @id @default(autoincrement())
  cle         String    @unique
  valeur      String
  description String?

  updatedAt   DateTime  @updatedAt
}

// ============================================
// TEMPLATES EMAILS
// ============================================

model EmailTemplate {
  id          Int       @id @default(autoincrement())

  code        String    @unique  // "MATCHING_NOTIFICATION", "COMPTE_ACTIVATION", etc.
  nom         String
  sujet       String
  contenuHtml String
  contenuText String?

  variables   String[]  // ["prenom", "nomOffre", "lienOffre"]

  actif       Boolean   @default(true)

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}
