// ============================================
// TALENTERO - Schéma Base de Données v2.0
// Plateforme de recrutement freelance IT
// Opérée par TRINEXTA by TrusTech IT Support
// ============================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// AUTHENTIFICATION & UTILISATEURS
// ============================================

model User {
  id            Int       @id @default(autoincrement())
  uid           String    @unique @default(uuid())
  email         String    @unique
  passwordHash  String?   // Nullable pour les comptes pré-créés par admin
  role          UserRole  @default(TALENT)
  emailVerified Boolean   @default(false)
  isActive      Boolean   @default(true)

  // Token pour finalisation de compte (import CV admin)
  activationToken       String?   @unique
  activationTokenExpiry DateTime?

  // Reset password
  resetToken            String?   @unique
  resetTokenExpiry      DateTime?

  // Relations selon le rôle
  talent        Talent?
  client        Client?

  // Sessions & Tokens
  sessions      Session[]

  // Notifications
  notifications Notification[]

  // Broadcast messages envoyés (admin uniquement)
  broadcastMessages BroadcastMessage[]

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  lastLoginAt   DateTime?

  // Créé par admin (import manuel)
  createdByAdmin Boolean  @default(false)

  // Dernier rappel d'activation envoyé
  lastReminderSentAt DateTime?
}

enum UserRole {
  TALENT    // Freelance
  CLIENT    // Entreprise
  ADMIN     // TRINEXTA
}

model Session {
  id        Int      @id @default(autoincrement())
  token     String   @unique
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    Int
  expiresAt DateTime
  userAgent String?
  ipAddress String?

  createdAt DateTime @default(now())
}

// ============================================
// TALENTS (FREELANCES)
// Format ID: TA + 4 chiffres (ex: TA4523)
// ============================================

model Talent {
  id                    Int       @id @default(autoincrement())
  uid                   String    @unique @default(uuid())
  // Code unique public (TA4523)
  codeUnique            String    @unique
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId                Int       @unique

  // Statut du compte
  compteLimite          Boolean   @default(false)  // Sans SIRET (en cours de création)
  compteComplet         Boolean   @default(false)  // Profil entièrement rempli
  importeParAdmin       Boolean   @default(false)  // CV importé manuellement

  // ===== INFORMATIONS NON MODIFIABLES PAR LE TALENT =====
  prenom                String
  nom                   String
  siret                 String?   @unique
  // ======================================================

  telephone             String?
  photoUrl              String?
  nationalite           String?   // Pour les projets secret défense

  // Entreprise / SIRET (optionnel si compteLimite)
  siren                 String?
  raisonSociale         String?
  dateCreationEntreprise DateTime?
  codeAPE               String?
  libelleAPE            String?
  formeJuridique        String?
  typeSociete           TypeSociete?
  siretVerifie          Boolean   @default(false)
  siretVerifieLe        DateTime?
  siretEnCoursCreation  Boolean   @default(false)  // En attente de SIRET

  // ===== GESTION ABSENCE SIRET =====
  raisonAbsenceSiret       RaisonAbsenceSiret?  // Pourquoi pas de SIRET
  dateCreationSocietePrevue DateTime?           // Date prévue création société (max 3 mois)
  societePortage           String?              // Nom société de portage si PORTAGE_SALARIAL

  // Suivi rappels SIRET (archivage auto après 3 mois)
  dateRappel30j            DateTime?            // Rappel J-30 envoyé
  dateRappel15j            DateTime?            // Rappel J-15 envoyé
  dateRappel7j             DateTime?            // Rappel J-7 envoyé
  dateArchivage            DateTime?            // Date archivage effectif
  // ==================================

  // TVA
  tvaIntracommunautaire String?
  assujettTva           Boolean   @default(false)

  // Adresse
  adresse               String?
  codePostal            String?
  ville                 String?
  pays                  String    @default("France")

  // Zone d'intervention et mobilité
  zonesIntervention     String[]
  permisConduire        Boolean   @default(false)
  vehicule              Boolean   @default(false)
  accepteDeplacementEtranger Boolean @default(false)

  // Profil Professionnel
  titrePoste            String?
  categorieProfessionnelle CategorieProfessionnelle?
  bio                   String?
  competences           String[]
  anneesExperience      Int       @default(0)

  // Conditions de travail
  tjm                   Int?
  tjmMin                Int?
  tjmMax                Int?
  mobilite              Mobilite  @default(FLEXIBLE)
  zonesGeographiques    String[]
  disponibilite         Disponibilite @default(IMMEDIATE)
  disponibleLe          DateTime?

  // Documents
  cvUrl                 String?
  cvOriginalName        String?
  cvParsedData          Json?

  // Compétences détaillées (extraites du CV ou ajoutées manuellement)
  logiciels             String[]
  frameworks            String[]
  baseDonnees           String[]
  methodologies         String[]
  outils                String[]

  // Extras
  softSkills            String[]
  langues               String[]
  loisirs               String[]
  certifications        String[]
  linkedinUrl           String?
  githubUrl             String?
  portfolioUrl          String?

  // Visibilité
  statut                TalentStatus @default(ACTIF)
  visiblePublic         Boolean   @default(true)
  visibleVitrine        Boolean   @default(false)  // Affiché sur la page vitrine

  // Email d'activation
  activationEmailEnvoye Boolean   @default(false)  // Email d'activation envoyé ?
  activationEmailEnvoyeLe DateTime?                // Date d'envoi de l'email

  // Relations
  experiences           Experience[]
  formations            Formation[]
  certificationsDetail  Certification[]    // Certifications structurees avec dates
  languesDetail         Langue[]           // Langues avec niveaux structures
  candidatures          Candidature[]
  matchs                Match[]
  alertes               Alerte[]
  conversations         ConversationParticipant[]
  entretiens            Entretien[]
  planning              TalentPlanning[]        // Planning de disponibilité
  missions              Mission[]               // Missions en cours/passées
  reviews               Review[]                // Avis reçus des clients
  contrats              Contrat[]               // Contrats avec les clients
  messagesRecus         BroadcastDestinataire[] // Messages broadcast reçus

  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@index([competences])
  @@index([ville])
  @@index([disponibilite])
  @@index([statut])
  @@index([categorieProfessionnelle])
  @@index([codeUnique])
}

// Catégories professionnelles pour la vitrine
enum CategorieProfessionnelle {
  DEVELOPPEUR
  CHEF_DE_PROJET
  SUPPORT_TECHNICIEN
  TECHNICIEN_HELPDESK_N1
  TECHNICIEN_HELPDESK_N2
  INGENIEUR_SYSTEME_RESEAU
  INGENIEUR_CLOUD
  DATA_BI
  DEVOPS_SRE
  CYBERSECURITE
  CONSULTANT_FONCTIONNEL
  ARCHITECTE
  SCRUM_MASTER
  PRODUCT_OWNER
  AUTRE
}

enum TypeSociete {
  AUTO_ENTREPRENEUR
  EURL
  SASU
  SARL
  SAS
  PORTAGE
  AUTRE
}

// Raison de l'absence de SIRET (pour les comptes limités)
enum RaisonAbsenceSiret {
  EN_COURS_CREATION      // Société en cours de création
  PORTAGE_SALARIAL       // Travaille via une société de portage
  MICRO_EN_COURS         // Micro-entreprise en cours d'immatriculation
  PREMIERE_MISSION       // Première mission, va créer sa société
  AUTRE                  // Autre raison
}

enum Mobilite {
  FULL_REMOTE
  HYBRIDE
  SUR_SITE
  FLEXIBLE
  DEPLACEMENT_MULTI_SITE
}

enum Disponibilite {
  IMMEDIATE
  SOUS_15_JOURS
  SOUS_1_MOIS
  SOUS_2_MOIS
  SOUS_3_MOIS
  DATE_PRECISE
  NON_DISPONIBLE
}

enum TalentStatus {
  ACTIF
  INACTIF
  EN_MISSION
  SUSPENDU
}

model Experience {
  id           Int        @id @default(autoincrement())
  talent       Talent     @relation(fields: [talentId], references: [id], onDelete: Cascade)
  talentId     Int

  poste        String
  entreprise   String?
  lieu         String?
  dateDebut    DateTime
  dateFin      DateTime?
  enCours      Boolean    @default(false)
  description  String?
  competences  String[]

  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
}

model Formation {
  id           Int        @id @default(autoincrement())
  talent       Talent     @relation(fields: [talentId], references: [id], onDelete: Cascade)
  talentId     Int

  diplome      String
  etablissement String?
  annee        Int?
  description  String?

  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
}

// Certifications avec dates et details
model Certification {
  id                  Int        @id @default(autoincrement())
  talent              Talent     @relation(fields: [talentId], references: [id], onDelete: Cascade)
  talentId            Int

  nom                 String                    // Ex: "AWS Solutions Architect Professional"
  organisme           String?                   // Ex: "Amazon Web Services"
  dateObtention       DateTime?                 // Date d'obtention
  dateExpiration      DateTime?                 // Date d'expiration (certaines expirent)
  numeroCertification String?                   // Numero/ID de la certification
  urlVerification     String?                   // URL pour verifier la certification

  createdAt           DateTime   @default(now())
  updatedAt           DateTime   @updatedAt
}

// Langues avec niveaux structures
model Langue {
  id                  Int        @id @default(autoincrement())
  talent              Talent     @relation(fields: [talentId], references: [id], onDelete: Cascade)
  talentId            Int

  langue              String                    // Ex: "Anglais"
  niveau              NiveauLangue              // A1, A2, B1, B2, C1, C2, NATIF
  scoreCertification  String?                   // Ex: "TOEIC 920", "TOEFL 105"

  createdAt           DateTime   @default(now())
  updatedAt           DateTime   @updatedAt
}

enum NiveauLangue {
  A1          // Debutant
  A2          // Elementaire
  B1          // Intermediaire
  B2          // Intermediaire avance
  C1          // Avance
  C2          // Maitrise
  NATIF       // Langue maternelle
}

// ============================================
// CLIENTS (ENTREPRISES)
// Format ID: CL + 4 chiffres (ex: CL1287)
// ============================================

model Client {
  id                    Int       @id @default(autoincrement())
  uid                   String    @unique @default(uuid())
  // Code unique public (CL1287)
  codeUnique            String    @unique
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId                Int       @unique

  // Type de client
  typeClient            TypeClient @default(DIRECT)

  // Entreprise
  raisonSociale         String
  siret                 String?   @unique
  siren                 String?
  codeAPE               String?
  formeJuridique        String?

  // Adresse principale
  adresse               String?
  codePostal            String?
  ville                 String?
  pays                  String    @default("France")

  // Infos entreprise
  description           String?
  secteurActivite       String?
  tailleEntreprise      TailleEntreprise?
  siteWeb               String?
  logoUrl               String?
  nombreSites           Int       @default(1)

  // Statut
  statut                ClientStatus @default(EN_ATTENTE)
  valideParAdmin        Boolean   @default(false)
  valideLe              DateTime?

  // Relations
  sites                 ClientSite[]
  contacts              ClientContact[]
  offres                Offre[]
  conversations         ConversationParticipant[]
  reviews               Review[]                    // Avis laissés sur les talents
  factures              Facture[]                   // Factures émises
  contrats              Contrat[]                   // Contrats avec les talents

  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@index([codeUnique])
}

enum TypeClient {
  DIRECT        // Client final qu'on gère directement
  SOUSTRAITANCE // ESN/Client intermédiaire (donneur d'ordre)
}

enum TailleEntreprise {
  TPE
  PME
  ETI
  GRANDE
}

enum ClientStatus {
  EN_ATTENTE
  ACTIF
  SUSPENDU
  ARCHIVE
}

// Sites multiples pour un client
model ClientSite {
  id          Int      @id @default(autoincrement())
  client      Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  clientId    Int

  nom         String   // "Siège Paris", "Agence Lyon"
  adresse     String
  codePostal  String
  ville       String
  pays        String   @default("France")
  telephone   String?

  estSiegeSocial Boolean @default(false)

  createdAt   DateTime @default(now())
}

// Contacts multiples pour un client
model ClientContact {
  id          Int      @id @default(autoincrement())
  client      Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  clientId    Int

  prenom      String
  nom         String
  email       String
  telephone   String?
  poste       String?  // "DRH", "CTO", "Responsable Recrutement"

  estContactPrincipal Boolean @default(false)
  recevoirNotifications Boolean @default(true)

  createdAt   DateTime @default(now())
}

// ============================================
// OFFRES D'EMPLOI
// Format ID: MI + 4 chiffres (ex: MI7834)
// ============================================

model Offre {
  id                    Int       @id @default(autoincrement())
  uid                   String    @unique @default(uuid())
  // Code unique public (MI7834)
  codeUnique            String    @unique
  slug                  String    @unique

  // Créateur
  client                Client?   @relation(fields: [clientId], references: [id], onDelete: SetNull)
  clientId              Int?
  // Si créée par admin sans client (offre TRINEXTA directe)
  createdByAdmin        Boolean   @default(false)
  offreTrinexta         Boolean   @default(false) // Offre sans client sur plateforme

  // Type d'offre
  typeOffre             TypeOffre @default(CLIENT_DIRECT)

  // Contenu
  titre                 String
  description           String
  responsabilites       String?
  profilRecherche       String?

  // Compétences
  competencesRequises   String[]
  competencesSouhaitees String[]

  // ===== TJM - GESTION COMPLEXE =====
  // TJM réel du client (JAMAIS affiché, ni au talent ni au client)
  tjmClientReel         Int?
  // TJM que TRINEXTA affiche aux talents (notre marge incluse)
  tjmAffiche            Int?
  tjmMin                Int?      // Fourchette basse affichée aux talents
  tjmMax                Int?      // Fourchette haute affichée aux talents
  // Si on n'a pas le TJM (souvent en sous-traitance)
  tjmADefinir           Boolean   @default(false)
  // ===================================

  // Localisation & Secteur
  secteur               String?   // Paris, 92, Lyon, etc.
  lieu                  String?   // Adresse précise
  codePostal            String?
  ville                 String?
  region                String?

  // Mode de travail
  mobilite              Mobilite  @default(FLEXIBLE)
  deplacementMultiSite  Boolean   @default(false)  // Plusieurs sites à couvrir
  deplacementEtranger   Boolean   @default(false)

  // Durée de la mission
  dureeNombre           Int?      // Nombre de jours/mois
  dureeUnite            DureeUnite @default(MOIS)
  renouvelable          Boolean   @default(false)
  dateDebut             DateTime?
  dateFin               DateTime?

  // Postes
  nombrePostes          Int       @default(1)

  // Expérience requise
  experienceMin         Int?

  // Habilitations
  habilitationRequise   Boolean   @default(false)
  typeHabilitation      String?   // "Secret Défense", "Confidentiel Défense"

  // ===== WORKFLOW DES STATUTS =====
  statut                OffreStatus @default(BROUILLON)
  // Dates du workflow
  envoyeeLe             DateTime? // Client envoie pour validation
  valideeLe             DateTime? // Admin valide
  publieLe              DateTime?
  shortlistEnvoyeeLe    DateTime?
  fermeeLe              DateTime?
  // ================================

  expireLe              DateTime?
  visiblePublic         Boolean   @default(true)

  // Résultat (pour sous-traitance)
  resultatMission       ResultatMission?
  dateResultat          DateTime?

  // Métriques
  nbVues                Int       @default(0)
  nbCandidatures        Int       @default(0)

  // Relations
  candidatures          Candidature[]
  matchs                Match[]
  shortlist             Shortlist?
  vues                  OffreVue[]
  conversations         Conversation[]
  entretiens            Entretien[]

  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@index([competencesRequises])
  @@index([statut])
  @@index([secteur])
  @@index([typeOffre])
  @@index([codeUnique])
}

enum TypeOffre {
  CLIENT_DIRECT    // Client direct qu'on gère (on envoie shortlist groupée)
  SOUSTRAITANCE    // Donneur d'ordre (CV anonymisés)
  TRINEXTA         // Offre créée par TRINEXTA sans client sur plateforme
}

enum DureeUnite {
  JOURS
  MOIS
}

enum OffreStatus {
  BROUILLON            // Client crée l'offre
  ENVOYEE              // Client envoie pour validation
  EN_ATTENTE_VALIDATION // En attente validation TRINEXTA
  PUBLIEE              // Validée et publiée, matching lancé
  EN_EVALUATION        // Évaluation des candidats en cours
  SHORTLIST_ENVOYEE    // Shortlist envoyée au client
  ENTRETIENS_EN_COURS  // Client sélectionne pour entretiens
  POURVUE              // Un candidat validé, offre fermée
  FERMEE               // Fermée sans succès
  ANNULEE              // Annulée par client ou admin
  EXPIREE              // Date d'expiration dépassée
}

enum ResultatMission {
  EN_ATTENTE
  GAGNEE        // On a remporté l'appel d'offre
  PERDUE        // On a perdu l'appel d'offre
}

// ============================================
// SHORTLIST (Liste de candidats pour une offre)
// ============================================

model Shortlist {
  id          Int       @id @default(autoincrement())
  uid         String    @unique @default(uuid())

  offre       Offre     @relation(fields: [offreId], references: [id], onDelete: Cascade)
  offreId     Int       @unique

  // Statut
  statut      ShortlistStatus @default(EN_COURS)

  // Envoi au client
  envoyeeLe   DateTime?

  // Candidats de la shortlist
  candidats   ShortlistCandidat[]

  notes       String?   // Notes internes TRINEXTA

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

enum ShortlistStatus {
  EN_COURS          // En construction
  PRETE             // Prête à être envoyée
  ENVOYEE           // Envoyée au client
  EN_ATTENTE_RETOUR // Attente retour client
  FINALISEE         // Retour reçu, traitement terminé
}

model ShortlistCandidat {
  id            Int       @id @default(autoincrement())

  shortlist     Shortlist @relation(fields: [shortlistId], references: [id], onDelete: Cascade)
  shortlistId   Int

  candidature   Candidature @relation(fields: [candidatureId], references: [id], onDelete: Cascade)
  candidatureId Int

  // Position dans la shortlist
  ordre         Int       @default(0)

  // Actions client
  statutClient  ShortlistCandidatStatus @default(EN_ATTENTE)

  // Retour client
  retenuParClient Boolean?
  commentaireClient String?

  // Demande d'infos complémentaires
  demandeInfos  Boolean   @default(false)
  questionClient String?
  reponseCandidat String?

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@unique([shortlistId, candidatureId])
}

enum ShortlistCandidatStatus {
  EN_ATTENTE          // Pas encore vu
  VU                  // Client a consulté le profil
  DEMANDE_ENTRETIEN   // Client veut un entretien
  DEMANDE_INFOS       // Client demande des infos
  SELECTIONNE         // Client valide ce candidat
  REFUSE              // Client refuse ce candidat
}

// ============================================
// MATCHING & CANDIDATURES
// ============================================

model Match {
  id            Int       @id @default(autoincrement())

  offre         Offre     @relation(fields: [offreId], references: [id], onDelete: Cascade)
  offreId       Int
  talent        Talent    @relation(fields: [talentId], references: [id], onDelete: Cascade)
  talentId      Int

  // Score de matching (0-100)
  score         Int
  scoreDetails  Json?

  // Compétences matchées
  competencesMatchees   String[]
  competencesManquantes String[]

  // Feedback de matching
  feedbackTjm           String?   // "Votre TJM est élevé, fourchette: 400-500€"
  feedbackExperience    String?   // "Il vous manque: React, AWS"
  feedbackAutre         String?

  // Problèmes détectés
  tjmTropHaut           Boolean   @default(false)
  experienceInsuffisante Boolean  @default(false)

  // Notification
  notificationEnvoyee Boolean @default(false)
  notificationEnvoyeeLe DateTime?

  // Statut
  vuParTalent   Boolean   @default(false)
  vuLe          DateTime?

  notes         String?

  createdAt     DateTime  @default(now())

  @@unique([offreId, talentId])
  @@index([score])
}

model Candidature {
  id            Int       @id @default(autoincrement())
  uid           String    @unique @default(uuid())

  offre         Offre     @relation(fields: [offreId], references: [id], onDelete: Cascade)
  offreId       Int
  talent        Talent    @relation(fields: [talentId], references: [id], onDelete: Cascade)
  talentId      Int

  // Origine de la candidature
  origine       CandidatureOrigine @default(POSTULE)

  // Candidature
  tjmPropose    Int?
  motivation    String?
  disponibilite Disponibilite?
  dateDisponibilite DateTime?

  // Matching au moment de la candidature
  scoreMatch    Int?

  // Pipeline
  statut        CandidatureStatus @default(NOUVELLE)

  // Dates importantes
  vueLe         DateTime?
  reponduLe     DateTime?

  // Shortlist
  shortlistCandidats ShortlistCandidat[]

  // Entretiens
  entretiens    Entretien[]

  // Notes
  notesTrinexta String?
  notesClient   String?

  // Notifications envoyées
  notificationRefusEnvoyee Boolean @default(false)
  notificationMissionPerdueEnvoyee Boolean @default(false)

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@unique([offreId, talentId])
}

enum CandidatureStatus {
  NOUVELLE
  VUE
  EN_REVUE           // En cours d'analyse
  PRE_SELECTIONNE    // Pré-sélectionné pour shortlist
  SHORTLIST          // Ajouté à la shortlist
  PROPOSEE_CLIENT    // Shortlist envoyée au client
  ENTRETIEN_DEMANDE  // Client demande entretien
  ENTRETIEN_PLANIFIE // Entretien confirmé
  ENTRETIEN_REALISE  // Entretien passé
  ACCEPTEE           // Candidat validé par client
  REFUSEE            // Refusé par client ou TRINEXTA
  MISSION_PERDUE     // Appel d'offre perdu (tous candidats)
  RETIREE            // Candidat s'est retiré
}

enum CandidatureOrigine {
  POSTULE            // Le talent a cliqué sur "Postuler"
  IMPORTE            // Importé par l'admin lors d'un import en masse
  MATCH_PROPOSE      // Ajouté par l'admin depuis un match
}

// ============================================
// ENTRETIENS
// ============================================

model Entretien {
  id              Int       @id @default(autoincrement())
  uid             String    @unique @default(uuid())

  offre           Offre     @relation(fields: [offreId], references: [id], onDelete: Cascade)
  offreId         Int

  candidature     Candidature @relation(fields: [candidatureId], references: [id], onDelete: Cascade)
  candidatureId   Int

  talent          Talent    @relation(fields: [talentId], references: [id], onDelete: Cascade)
  talentId        Int

  // Proposition de date/heure par le client
  dateProposee    DateTime
  heureDebut      String    // "14:00"
  heureFin        String?   // "15:00"

  // Confirmation talent
  statut          EntretienStatus @default(EN_ATTENTE_CONFIRMATION)
  confirmeParTalent Boolean @default(false)
  confirmeParTalentLe DateTime?

  // Si le talent propose une autre date
  dateAlternative DateTime?
  heureAlternative String?

  // Lien visio (Teams, Meet, etc.)
  lienVisio       String?
  typeVisio       TypeVisio?

  // Résultat
  resultat        EntretienResultat?
  notesEntretien  String?

  // Notifications
  notificationClientEnvoyee Boolean @default(false)
  notificationTalentEnvoyee Boolean @default(false)
  rappelEnvoye    Boolean   @default(false)

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}

enum EntretienStatus {
  EN_ATTENTE_CONFIRMATION   // Talent doit confirmer
  CONFIRME                  // Talent a confirmé
  DATE_ALTERNATIVE_PROPOSEE // Talent propose autre date
  ANNULE                    // Annulé
  REALISE                   // Entretien passé
}

enum TypeVisio {
  TEAMS
  MEET
  ZOOM
  AUTRE
}

enum EntretienResultat {
  EN_ATTENTE
  POSITIF
  NEGATIF
  RESERVE
}

// ============================================
// MESSAGERIE / CONVERSATIONS
// Chaque conversation est liée à une offre
// ============================================

model Conversation {
  id          Int       @id @default(autoincrement())
  uid         String    @unique @default(uuid())

  // Liée à une offre (optionnel - peut être une conversation directe)
  offre       Offre?    @relation(fields: [offreId], references: [id], onDelete: Cascade)
  offreId     Int?

  // Type de conversation
  type        ConversationType @default(OFFRE)

  // Sujet
  sujet       String?

  // Participants
  participants ConversationParticipant[]

  // Messages
  messages    Message[]

  // Statut
  archivee    Boolean   @default(false)

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([offreId])
  @@index([type])
}

enum ConversationType {
  OFFRE       // Conversation liée à une offre
  DIRECT      // Message direct admin -> talent
  SUPPORT     // Support/Question du talent
}

model ConversationParticipant {
  id              Int       @id @default(autoincrement())

  conversation    Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  conversationId  Int

  // Participant (un seul des trois)
  talent          Talent?   @relation(fields: [talentId], references: [id], onDelete: Cascade)
  talentId        Int?
  client          Client?   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  clientId        Int?
  isAdmin         Boolean   @default(false)  // TRINEXTA

  // Dernier message lu
  dernierMessageLu Int?

  createdAt       DateTime  @default(now())

  @@unique([conversationId, talentId])
  @@unique([conversationId, clientId])
}

model Message {
  id              Int       @id @default(autoincrement())
  uid             String    @unique @default(uuid())

  conversation    Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  conversationId  Int

  // Expéditeur (un seul des trois)
  expediteurTalentId  Int?
  expediteurClientId  Int?
  expediteurAdmin     Boolean @default(false)  // Message de TRINEXTA

  // Contenu
  contenu         String

  // Pièces jointes
  pieceJointe     String?
  pieceJointeNom  String?

  // Lu par les destinataires
  createdAt       DateTime  @default(now())

  @@index([conversationId])
}

// ============================================
// MESSAGERIE BROADCAST (Admin vers talents)
// ============================================

model BroadcastMessage {
  id              Int       @id @default(autoincrement())
  uid             String    @unique @default(uuid())

  // Expéditeur (admin)
  expediteurId    Int?
  expediteur      User?     @relation(fields: [expediteurId], references: [id], onDelete: SetNull)

  // Sujet et contenu
  sujet           String
  contenu         String

  // Destinataires
  destinataires   BroadcastDestinataire[]

  // Stats
  totalEnvoye     Int       @default(0)
  totalLu         Int       @default(0)

  createdAt       DateTime  @default(now())

  @@index([createdAt])
}

model BroadcastDestinataire {
  id              Int       @id @default(autoincrement())

  message         BroadcastMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)
  messageId       Int

  talent          Talent    @relation(fields: [talentId], references: [id], onDelete: Cascade)
  talentId        Int

  // Statut
  lu              Boolean   @default(false)
  luLe            DateTime?

  createdAt       DateTime  @default(now())

  @@unique([messageId, talentId])
  @@index([talentId])
}

// ============================================
// ALERTES & NOTIFICATIONS
// ============================================

model Alerte {
  id              Int       @id @default(autoincrement())
  talent          Talent    @relation(fields: [talentId], references: [id], onDelete: Cascade)
  talentId        Int

  nom             String?
  competences     String[]
  tjmMin          Int?
  mobilite        Mobilite?
  lieux           String[]

  frequence       AlerteFrequence @default(INSTANTANEE)
  active          Boolean   @default(true)

  derniereNotif   DateTime?
  nbOffresEnvoyees Int      @default(0)

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}

enum AlerteFrequence {
  INSTANTANEE
  QUOTIDIENNE
  HEBDOMADAIRE
}

model Notification {
  id          Int       @id @default(autoincrement())

  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId      Int

  type        NotificationType

  titre       String
  message     String
  lien        String?

  // Données additionnelles
  data        Json?

  lu          Boolean   @default(false)
  luLe        DateTime?

  createdAt   DateTime  @default(now())

  @@index([userId, lu])
  @@index([type])
}

enum NotificationType {
  // Offres
  NOUVELLE_OFFRE_MATCH       // Talent: nouvelle offre qui matche
  OFFRE_PUBLIEE              // Client: son offre est publiée

  // Candidatures
  NOUVELLE_CANDIDATURE       // Admin: nouvelle candidature
  CANDIDATURE_RECUE          // Admin: candidature reçue
  STATUT_CANDIDATURE         // Talent: statut de sa candidature change

  // Shortlist
  SHORTLIST_ENVOYEE          // Client: shortlist reçue
  SHORTLIST_RETOUR           // Admin: client a donné retour

  // Entretiens
  ENTRETIEN_DEMANDE          // Talent: demande d'entretien
  ENTRETIEN_CONFIRME         // Client: talent a confirmé
  ENTRETIEN_RAPPEL           // Tous: rappel entretien
  ENTRETIEN_ANNULE           // Tous: entretien annulé

  // Messages
  NOUVEAU_MESSAGE            // Tous: nouveau message
  DEMANDE_INFOS              // Talent: client demande infos

  // Résultats
  CANDIDAT_SELECTIONNE       // Talent: vous êtes sélectionné!
  CANDIDAT_REFUSE            // Talent: profil non retenu
  MISSION_PERDUE             // Talent: appel d'offre perdu
  MISSION_GAGNEE             // Admin: mission gagnée

  // Compte
  VALIDATION_COMPTE          // Client: compte validé
  BIENVENUE                  // Tous: bienvenue sur la plateforme

  // Système
  SYSTEME                    // Message système

  // Reviews
  REVIEW_RECUE               // Talent: nouvelle review reçue
}

// ============================================
// REVIEWS & REPUTATION
// ============================================

model Review {
  id              Int       @id @default(autoincrement())
  uid             String    @unique @default(uuid())

  // Talent évalué
  talent          Talent    @relation(fields: [talentId], references: [id], onDelete: Cascade)
  talentId        Int

  // Client qui évalue
  client          Client    @relation(fields: [clientId], references: [id], onDelete: Cascade)
  clientId        Int

  // Mission concernée (optionnel)
  missionId       Int?

  // Candidature concernée (optionnel)
  candidatureId   Int?

  // Notes (1-5)
  noteGlobale         Int       // Note globale
  noteCompetences     Int?      // Note compétences techniques
  noteCommunication   Int?      // Note communication
  notePonctualite     Int?      // Note ponctualité/respect des délais
  noteQualite         Int?      // Note qualité du travail

  // Commentaire
  titre           String?
  commentaire     String

  // Recommandation
  recommande      Boolean   @default(true)

  // Validation
  statut          ReviewStatus @default(EN_ATTENTE)
  valideParAdmin  Boolean   @default(false)
  valideLe        DateTime?
  validePar       Int?      // Admin ID

  // Réponse du talent
  reponse         String?
  reponduLe       DateTime?

  // Visibilité
  public          Boolean   @default(true)

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([talentId])
  @@index([clientId])
  @@index([statut])
}

enum ReviewStatus {
  EN_ATTENTE      // En attente de validation
  PUBLIEE         // Publiée et visible
  REJETEE         // Rejetée par l'admin
  MASQUEE         // Masquée temporairement
}

// ============================================
// EMAILS (Microsoft Graph)
// ============================================

model EmailLog {
  id          Int       @id @default(autoincrement())

  destinataire String
  sujet        String
  template     String    // Nom du template utilisé

  // Contexte
  userId       Int?
  offreId      Int?
  candidatureId Int?
  entretienId  Int?

  // Microsoft Graph
  messageId    String?   // ID du message dans Graph

  statut       EmailStatus @default(EN_ATTENTE)
  envoyeLe     DateTime?
  erreur       String?

  createdAt    DateTime  @default(now())
}

enum EmailStatus {
  EN_ATTENTE
  ENVOYE
  ERREUR
}

// ============================================
// LOGS & ANALYTICS
// ============================================

model AuditLog {
  id          Int       @id @default(autoincrement())

  userId      Int?
  action      String
  entite      String
  entiteId    Int?

  details     Json?
  ipAddress   String?
  userAgent   String?

  createdAt   DateTime  @default(now())

  @@index([userId])
  @@index([action])
  @@index([createdAt])
}

model OffreVue {
  id          Int       @id @default(autoincrement())
  offre       Offre     @relation(fields: [offreId], references: [id], onDelete: Cascade)
  offreId     Int

  talentId    Int?
  ipAddress   String?
  userAgent   String?

  createdAt   DateTime  @default(now())

  @@index([offreId])
}

// ============================================
// CONFIGURATION PLATEFORME
// ============================================

model ConfigPlateforme {
  id          Int       @id @default(autoincrement())
  cle         String    @unique
  valeur      String
  description String?

  updatedAt   DateTime  @updatedAt
}

// ============================================
// TEMPLATES EMAILS
// ============================================

model EmailTemplate {
  id          Int       @id @default(autoincrement())

  code        String    @unique  // "MATCHING_NOTIFICATION", "COMPTE_ACTIVATION", etc.
  nom         String
  sujet       String
  contenuHtml String
  contenuText String?

  variables   String[]  // ["prenom", "nomOffre", "lienOffre"]

  actif       Boolean   @default(true)

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

// ============================================
// PAGES LÉGALES
// ============================================

model PageLegale {
  id          Int       @id @default(autoincrement())

  slug        String    @unique  // "cgu", "cgv", "mentions-legales", "confidentialite"
  titre       String
  contenu     String    // HTML content

  version     Int       @default(1)
  publieLe    DateTime  @default(now())

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

// ============================================
// ACCEPTATION CGU/CGV
// ============================================

model AcceptationCGU {
  id          Int       @id @default(autoincrement())

  userId      Int
  typePage    String    // "cgu", "cgv"
  version     Int

  ipAddress   String?
  userAgent   String?

  accepteLe   DateTime  @default(now())

  @@index([userId])
}

// ============================================
// PLANNING FREELANCE (Disponibilités)
// ============================================

model TalentPlanning {
  id          Int       @id @default(autoincrement())

  talent      Talent    @relation(fields: [talentId], references: [id], onDelete: Cascade)
  talentId    Int

  // Date concernée
  date        DateTime  @db.Date

  // Type de jour
  type        PlanningType @default(DISPONIBLE)

  // Si en mission, référence à la mission
  mission     Mission?  @relation(fields: [missionId], references: [id], onDelete: SetNull)
  missionId   Int?

  // Notes
  notes       String?

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@unique([talentId, date])
  @@index([talentId])
  @@index([date])
  @@index([type])
}

enum PlanningType {
  DISPONIBLE        // Disponible pour missions
  INDISPONIBLE      // Indisponible (raison personnelle)
  EN_MISSION        // En mission chez un client
  CONGE             // Congés payés/vacances
  ARRET_MALADIE     // Arrêt maladie
  FORMATION         // En formation
  INTERCONTRAT      // Entre deux missions (disponible mais pas actif)
}

// ============================================
// MISSIONS (Missions effectuées par les talents)
// ============================================

model Mission {
  id              Int       @id @default(autoincrement())
  uid             String    @unique @default(uuid())

  talent          Talent    @relation(fields: [talentId], references: [id], onDelete: Cascade)
  talentId        Int

  // Offre d'origine (si applicable)
  offreId         Int?

  // Client
  clientNom       String
  clientContact   String?

  // Détails mission
  titre           String
  description     String?
  lieu            String?

  // Période
  dateDebut       DateTime
  dateFin         DateTime?
  enCours         Boolean   @default(true)

  // TJM négocié
  tjm             Int?

  // Statut
  statut          MissionStatus @default(EN_COURS)

  // Planning associé
  planning        TalentPlanning[]

  // Notes
  notes           String?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([talentId])
  @@index([statut])
}

enum MissionStatus {
  EN_COURS
  TERMINEE
  ANNULEE
}

// ============================================
// FACTURATION
// ============================================

model Facture {
  id              Int       @id @default(autoincrement())
  uid             String    @unique @default(uuid())

  // Numéro de facture unique (FAC-2024-0001)
  numero          String    @unique

  // Client facturé
  client          Client    @relation(fields: [clientId], references: [id], onDelete: Cascade)
  clientId        Int

  // Mission concernée (optionnel)
  missionId       Int?

  // Offre concernée (optionnel)
  offreId         Int?

  // Talent concerné (pour info)
  talentId        Int?

  // Informations client au moment de la facturation
  clientNom       String
  clientAdresse   String?
  clientSiret     String?

  // Détails facturation
  description     String

  // Période facturée
  periodeDebut    DateTime?
  periodeFin      DateTime?

  // Montants
  nbJours         Float?            // Nombre de jours facturés
  tjm             Int?              // TJM appliqué
  montantHT       Float             // Montant hors taxes
  tauxTVA         Float   @default(20)  // Taux TVA (%)
  montantTVA      Float             // Montant TVA
  montantTTC      Float             // Montant TTC

  // Frais additionnels
  frais           Json?             // [{description, montant}]

  // Remises
  remise          Float?            // Montant de remise
  remiseMotif     String?

  // Statut
  statut          FactureStatut @default(BROUILLON)

  // Dates
  dateEmission    DateTime?
  dateEcheance    DateTime?
  datePaiement    DateTime?

  // Paiement
  modePaiement    ModePaiement?
  referencePaiement String?

  // Notes
  notes           String?
  notesInternes   String?           // Notes visibles seulement par admin

  // PDF
  pdfUrl          String?

  // Envoi
  envoyeParEmail  Boolean   @default(false)
  envoyeLe        DateTime?

  // Relances
  nbRelances      Int       @default(0)
  derniereRelance DateTime?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  createdBy       Int?              // Admin qui a créé

  // Lignes de facture détaillées
  lignes          LigneFacture[]

  @@index([clientId])
  @@index([statut])
  @@index([dateEmission])
  @@index([numero])
}

model LigneFacture {
  id              Int       @id @default(autoincrement())

  facture         Facture   @relation(fields: [factureId], references: [id], onDelete: Cascade)
  factureId       Int

  description     String
  quantite        Float     @default(1)
  unite           String?   @default("jour")  // jour, heure, forfait
  prixUnitaire    Float
  montantHT       Float

  // Ordre d'affichage
  ordre           Int       @default(0)

  createdAt       DateTime  @default(now())

  @@index([factureId])
}

enum FactureStatut {
  BROUILLON       // En cours de rédaction
  EMISE           // Envoyée au client
  PAYEE           // Paiement reçu
  PARTIELLEMENT_PAYEE  // Paiement partiel
  EN_RETARD       // Échéance dépassée
  ANNULEE         // Annulée
  AVOIR           // Avoir (remboursement)
}

enum ModePaiement {
  VIREMENT
  CHEQUE
  CB
  PRELEVEMENT
  ESPECES
  AUTRE
}

// ============================================
// CONTRATS
// ============================================

model Contrat {
  id              Int       @id @default(autoincrement())
  uid             String    @unique @default(uuid())

  // Numéro de contrat unique (CTR-2024-0001)
  numero          String    @unique

  // Parties du contrat
  talent          Talent    @relation(fields: [talentId], references: [id], onDelete: Cascade)
  talentId        Int
  client          Client    @relation(fields: [clientId], references: [id], onDelete: Cascade)
  clientId        Int

  // Références associées
  offreId         Int?
  candidatureId   Int?
  missionId       Int?

  // Informations du talent au moment du contrat
  talentNom       String
  talentPrenom    String
  talentSiret     String?
  talentAdresse   String?

  // Informations du client au moment du contrat
  clientNom       String
  clientSiret     String?
  clientAdresse   String?

  // Type de contrat
  typeContrat     TypeContrat @default(FREELANCE)

  // Détails de la mission
  titre           String              // Titre de la mission
  description     String?             // Description détaillée
  lieu            String?             // Lieu d'exécution
  mobilite        Mobilite?           // Mode de travail

  // Période
  dateDebut       DateTime
  dateFin         DateTime?
  dureeNombre     Int?
  dureeUnite      DureeUnite @default(MOIS)
  renouvelable    Boolean   @default(false)

  // Conditions de renouvellement
  conditionsRenouvellement String?
  preavisJours    Int       @default(30)   // Préavis en jours

  // Conditions financières
  tjm             Int                 // TJM négocié
  tauxTVA         Float     @default(20)
  plafondJours    Int?                // Nombre max de jours
  plafondMontant  Float?              // Montant max HT

  // Clauses particulières
  clauses         Json?               // [{titre, contenu}]
  conditionsParticulieres String?

  // Statut du contrat
  statut          ContratStatut @default(BROUILLON)

  // Dates du workflow
  envoyeLe        DateTime?           // Envoyé pour signature
  signeParTalent  Boolean   @default(false)
  signeParTalentLe DateTime?
  signeParClient  Boolean   @default(false)
  signeParClientLe DateTime?
  activeDepuis    DateTime?           // Date d'activation
  termineLe       DateTime?           // Date de fin effective
  motifFin        String?             // Motif de fin anticipée

  // Documents
  pdfUrl          String?             // PDF du contrat
  signatureTalentUrl String?          // Signature du talent
  signatureClientUrl String?          // Signature du client

  // Avenants
  avenants        Avenant[]

  // Notes
  notes           String?
  notesInternes   String?             // Notes visibles seulement par admin

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  createdBy       Int?                // Admin qui a créé

  @@index([talentId])
  @@index([clientId])
  @@index([statut])
  @@index([numero])
}

model Avenant {
  id              Int       @id @default(autoincrement())
  uid             String    @unique @default(uuid())

  contrat         Contrat   @relation(fields: [contratId], references: [id], onDelete: Cascade)
  contratId       Int

  // Numéro d'avenant (AVN-CTR-2024-0001-01)
  numero          String    @unique

  // Modifications
  objet           String                // Objet de l'avenant
  modifications   String                // Description des modifications

  // Nouvelles conditions (si modifiées)
  nouveauTjm      Int?
  nouvelleDateFin DateTime?
  nouveauPlafond  Float?

  // Statut
  statut          ContratStatut @default(BROUILLON)
  signeParTalent  Boolean   @default(false)
  signeParTalentLe DateTime?
  signeParClient  Boolean   @default(false)
  signeParClientLe DateTime?

  // PDF
  pdfUrl          String?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([contratId])
}

enum TypeContrat {
  FREELANCE           // Contrat de prestation freelance standard
  PORTAGE             // Contrat via portage salarial
  REGIE               // Contrat de régie
  FORFAIT             // Contrat au forfait
  CDI_CHANTIER        // CDI de chantier
}

enum ContratStatut {
  BROUILLON           // En cours de rédaction
  EN_ATTENTE_SIGNATURE // Envoyé pour signature
  SIGNE_TALENT        // Signé par le talent uniquement
  SIGNE_CLIENT        // Signé par le client uniquement
  ACTIF               // Signé par les deux parties, en cours
  SUSPENDU            // Suspendu temporairement
  TERMINE             // Terminé normalement
  RESILIE             // Résilié avant terme
  ANNULE              // Annulé avant exécution
}
